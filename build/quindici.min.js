/*! quindici 2014-01-29 */
$(function(){for(var a,b="2:2",c=parseInt(b.split(":")[0]),d=parseInt(b.split(":")[1]),e=$("#puzzle"),f=e.find("figure"),g=f.find("img"),h=g.attr("src"),i=$("<div></div>"),j=Math.floor(g.width()/c),k=Math.floor(g.height()/d),l=0,m=[],n={top:0,left:0,bottom:k,right:j},o={},p={},q=e.find("#time").find("span"),r=0,s=d;s>r;r++)for(var t=0,u=c;u>t;t++){var v=k*r,w=j*t;i.clone().attr("id",l++).css({width:j,height:k,position:"absolute",top:v,left:w,backgroundImage:["url(",h,")"].join(""),backgroundPosition:["-",j*t,"px ","-",k*r,"px"].join("")}).appendTo(f),m.push({top:v,left:w})}g.remove(),e.find("#0").remove(),m.shift(),$("#start").on("click",function(){function b(a){var b=a.length;if(0===b)return!1;for(;--b;){var c=Math.floor(Math.random()*(b+1)),d=a[b],e=a[c];a[b]=e,a[c]=d}}function c(){23===p.hours&&59===p.minutes&&59===p.seconds?clearInterval(a):59===p.minutes&&59===p.seconds?(p.hours++,p.minutes=0,p.seconds=0):59===p.seconds?(p.minutes++,p.seconds=0):p.seconds++,newHours=p.hours<=9?"0"+p.hours:p.hours,newMins=p.minutes<=9?"0"+p.minutes:p.minutes,newSecs=p.seconds<=9?"0"+p.seconds:p.seconds,q.text([newHours,":",newMins,":",newSecs].join(""))}function d(a){return{top:parseInt(a.css("top")),bottom:parseInt(a.css("top"))+k,left:parseInt(a.css("left")),right:parseInt(a.css("left"))+j}}var g=f.children();b(g),$.each(g,function(a){g.eq(a).css(m[a])}),g.appendTo(f),n.top=0,n.left=0,e.find("#ui").find("p").not("#time").remove(),a&&(clearInterval(a),q.text("00:00:00")),a=setInterval(c,1e3),p.seconds=0,p.minutes=0,p.hours=0,g.draggable({containment:"parent",grid:[j,k],start:function(a,b){console.log("Start dragging");var c=d(b.helper);if(c.left===n.left)b.helper.draggable("option","axis","y");else{if(c.top!==n.top)return b.helper.trigger("mouseup"),!1;b.helper.draggable("option","axis","x")}return c.bottom<n.top||c.top>n.bottom||c.left>n.right||c.right<n.left?(b.helper.trigger("mouseup"),!1):(o.top=c.top,void(o.left=c.left))},drag:function(a,b){console.log("In dragging");var c=d(b.helper);return b.helper.draggable("option","revert",!1),c.top===n.top&&c.left===n.left?(b.helper.trigger("mouseup"),!1):c.top>n.bottom||c.bottom<n.top||c.left>n.right||c.right<n.left?(b.helper.trigger("mouseup").css({top:o.top,left:o.left}),!1):void 0},stop:function(b,c){console.log("finished dragging");var e=d(c.helper),f=0;if(e.top===n.top&&e.left===n.left&&(n.top=o.top,n.left=o.left,n.bottom=o.top+k,n.right=o.left+j),$.each(m,function(a){var b=$("#"+(a+1)),c=d(b);m[a].top===c.top&&m[a].left===c.left&&f++}),f===m.length){clearInterval(a),$("<p></p>",{text:"Congratulations, you solved the puzzle!"}).appendTo("#ui");var g=60*p.hours*60+60*p.minutes+p.seconds;if(localStorage.getItem("puzzleBestTime")){var h=localStorage.getItem("puzzleBestTime");h>g&&(localStorage.setItem("puzzleBestTime",g),$("<p></p>",{text:"You got a new best time!"}).appendTo("#ui"))}else localStorage.setItem("puzzleBestTime",g),$("<p></p>",{text:"You got a new best time!"}).appendTo("#ui")}}})})});